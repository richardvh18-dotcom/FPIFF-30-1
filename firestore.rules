rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPERS ---
    
    // Controleert of de gebruiker is ingelogd via Firebase Auth
    function isSignedIn() {
      return request.auth != null;
    }

    // --- PRODUCTIE REGELS (Future Factory Root) ---

    // Deze regel geeft toegang tot alle modules onder de nieuwe hoofdmap:
    // - /future-factory/production/... (Orders, Producten, Tracking)
    // - /future-factory/settings/...   (Matrices, Fabrieksconfig)
    // - /future-factory/Users/...      (Accounts, Personeel)
    match /future-factory/{module}/{document=**} {
      allow read, write: if isSignedIn();
    }

    // --- AUTOMATION RULES (Centraal beheer) ---
    match /automationRules/{document=**} {
      allow read, write: if isSignedIn();
    }
    match /automationExecutions/{document=**} {
      allow read, write: if isSignedIn();
    }

    // --- MIGRATIE & BOOTSTRAP (Oude Structuur) ---
    
    // Tijdelijke toegang tot de oude artifacts map zodat de migratietool de data kan lezen
    match /artifacts/{appId}/public/data/{module}/{document=**} {
      allow read, write: if isSignedIn();
    }

    // Specifieke regel voor de GodModeBootstrap
    // Hiermee kan de eerste Admin (Richard) zijn account initialiseren
    match /artifacts/fittings-app-v1/public/data/user_roles/{userId} {
      allow read, write: if true; 
    }

    // --- VEILIGHEID FALLBACK ---
    
    // Alles wat niet hierboven is gedefinieerd wordt standaard geblokkeerd
    match /{document=**} {
      allow read, write: if false;
    }
  }
}